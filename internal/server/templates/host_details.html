{{define "content"}}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Host Details: {{.Host.IP}}</h1>
    <!-- Valid hidden input for JS to read -->
    <input type="hidden" id="hostIdField" value="{{.Host.ID}}">
</div>

<div class="row">
    <!-- Left Column: Host & Scan Properties -->
    <div class="col-md-7">
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header border-bottom-0 pb-0">
                <h5 class="card-title text-muted small text-uppercase fw-bold">Host Properties</h5>
            </div>
            <div class="card-body">
                <!-- Tags -->
                <div class="mb-3">
                    {{range .Host.Tags}}
                    <span class="badge me-1" style="background-color: {{.Color}}; font-size: 0.9em;">
                        {{.Name}}
                        <a href="javascript:void(0)" onclick="removeTag('{{.ID}}', '{{.Name}}')"
                            class="text-white ms-1 text-decoration-none" title="Remove Tag">&times;</a>
                    </span>
                    {{end}}
                    <button class="btn btn-sm btn-outline-secondary rounded-pill py-0" style="font-size: 0.8em;"
                        data-bs-toggle="modal" data-bs-target="#addTagModal">+ Tag</button>
                </div>

                <div class="row mb-2">
                    <div class="col-sm-4 fw-bold">Hostname:</div>
                    <div class="col-sm-8">{{.Host.Hostname}}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4 fw-bold">OS:</div>
                    <div class="col-sm-8">{{.Host.OS}}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4 fw-bold">Last Seen:</div>
                    <div class="col-sm-8">{{.Host.UpdatedAt.Format "2006-01-02 15:04"}}</div>
                </div>
            </div>
        </div>

        <!-- Scan History / Categories -->
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header border-bottom-0 pb-0">
                <h5 class="card-title text-muted small text-uppercase fw-bold">Scan Categories</h5>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {{range .Host.Scans}}
                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-4">
                        <div>
                            <strong>{{.Name}}</strong><br>
                            <small class="text-muted">{{.PolicyName}}</small>
                        </div>
                        <span class="badge bg-light text-dark border rounded-pill">{{.ScanStart.Format "Jan 02"}}</span>
                    </li>
                    {{end}}
                </ul>
            </div>
        </div>

        <!-- Latest Scan Metadata (Fixed Visibility) -->
        {{if gt (len .Host.Scans) 0}}
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header border-bottom-0 pb-0">
                <h5 class="card-title text-muted small text-uppercase fw-bold">Latest Scan Details</h5>
            </div>
            <div class="card-body">
                {{$count := len .Host.Scans}}
                {{$idx := sub $count 1}}
                {{$latest := index .Host.Scans $idx}}
                <div class="row mb-2">
                    <div class="col-sm-4 fw-bold">Policy:</div>
                    <div class="col-sm-8">{{$latest.PolicyName}}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4 fw-bold">Start:</div>
                    <div class="col-sm-8">{{$latest.ScanStart.Format "2006-01-02 15:04"}}</div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-4 fw-bold">End:</div>
                    <div class="col-sm-8">{{$latest.ScanEnd.Format "2006-01-02 15:04"}}</div>
                </div>
            </div>
        </div>
        {{end}}
    </div>

    <!-- Right Column: Graphs -->
    <div class="col-md-5">
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header border-bottom-0 pb-0">
                <h5 class="card-title text-muted small text-uppercase fw-bold">Active Vulnerabilities</h5>
            </div>
            <div class="card-body">
                <canvas id="vulnChart" height="250"></canvas>
            </div>
        </div>
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-white border-bottom-0 pb-0">
                <h5 class="card-title text-muted small text-uppercase fw-bold">Remediation Status</h5>
            </div>
            <div class="card-body">
                <canvas id="fixedVulnChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Finding Lists with DataTables look-alike styling -->
<div class="card shadow-sm border-0 mt-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Finding Details</h5>
            <div class="w-25">
                <input type="text" id="findingSearch" class="form-control form-control-sm"
                    placeholder="Search findings..." onkeyup="filterFindings()">
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <ul class="nav nav-tabs nav-justified" id="vulnTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active rounded-0" id="active-tab" data-bs-toggle="tab"
                    data-bs-target="#active-pane" type="button" role="tab" aria-controls="active-pane"
                    aria-selected="true">Active Findings</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-0" id="resolved-tab" data-bs-toggle="tab"
                    data-bs-target="#resolved-pane" type="button" role="tab" aria-controls="resolved-pane"
                    aria-selected="false">Resolved History</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link rounded-0" id="accepted-tab" data-bs-toggle="tab"
                    data-bs-target="#accepted-pane" type="button" role="tab" aria-controls="accepted-pane"
                    aria-selected="false">Accepted Risks</button>
            </li>
        </ul>

        <div class="tab-content" id="vulnTabsContent">
            <div class="tab-pane fade show active" id="active-pane" role="tabpanel" aria-labelledby="active-tab">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0" id="activeFindingsTable">
                        <thead>
                            <tr>
                                <th>Severity</th>
                                <th>Plugin ID</th>
                                <th>Name</th>
                                <th>Family</th>
                                <th>Port/Protocol</th>
                                <th>First Seen</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Findings}}
                            {{if eq .Status "Open"}}
                            <tr>
                                <td><span class="badge severity-{{.Vuln.Severity}}">{{.Vuln.Severity}}</span></td>
                                <td><a href="https://www.tenable.com/plugins/nessus/{{.Vuln.PluginID}}" target="_blank"
                                        class="text-decoration-none">{{.Vuln.PluginID}}</a></td>
                                <td>{{.Vuln.Name}}</td>
                                <td><span class="badge bg-light text-dark border">{{.Vuln.Family}}</span></td>
                                <td><span class="font-monospace small">{{.Port}}/{{.Protocol}}</span></td>
                                <td class="small">{{.FirstSeen.Format "2006-01-02"}}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary py-0" style="font-size: 0.75rem"
                                        onclick="openSnooze({{.ID}})">Accept</button>
                                    <button class="btn btn-sm btn-outline-success py-0 ms-1" style="font-size: 0.75rem"
                                        onclick="openResolve({{.ID}})">Resolve</button>
                                </td>
                            </tr>
                            {{end}}
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="resolved-pane" role="tabpanel" aria-labelledby="resolved-tab">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0" id="resolvedFindingsTable">
                        <thead>
                            <tr>
                                <th>Severity</th>
                                <th>Plugin ID</th>
                                <th>Name</th>
                                <th>Remediated Date</th>
                                <th>Resolution Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Findings}}
                            {{if eq .Status "Fixed"}}
                            <tr>
                                <td><span class="badge severity-{{.Vuln.Severity}}">{{.Vuln.Severity}}</span></td>
                                <td><a href="https://www.tenable.com/plugins/nessus/{{.Vuln.PluginID}}" target="_blank"
                                        class="text-decoration-none">{{.Vuln.PluginID}}</a></td>
                                <td>{{.Vuln.Name}}</td>
                                <td class="small text-success fw-bold">{{.LastSeen.Format "2006-01-02"}}</td>
                                <td class="small text-muted">{{.ResolutionNote}}</td>
                            </tr>
                            {{end}}
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="accepted-pane" role="tabpanel" aria-labelledby="accepted-tab">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0" id="acceptedFindingsTable">
                        <thead>
                            <tr>
                                <th>Severity</th>
                                <th>Plugin ID</th>
                                <th>Name</th>
                                <th>Risk Accepted Until</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Findings}}
                            {{if eq .Status "Snoozed"}}
                            <tr>
                                <td><span class="badge severity-{{.Vuln.Severity}}">{{.Vuln.Severity}}</span></td>
                                <td><a href="https://www.tenable.com/plugins/nessus/{{.Vuln.PluginID}}" target="_blank"
                                        class="text-decoration-none">{{.Vuln.PluginID}}</a></td>
                                <td>{{.Vuln.Name}}</td>
                                <td><span class="font-monospace small text-warning">{{.SnoozedUntil.Format
                                        "2006-01-02"}}</span></td>
                                <td class="small text-muted">{{.ExceptionReason}}</td>
                            </tr>
                            {{end}}
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="mt-4">
    <a href="/hosts" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Asset Inventory</a>
</div>
</div>

<!-- Add Tag Modal -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="/api/hosts/{{.Host.ID}}/tags" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Tag to Host</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tag Name</label>
                        <input type="text" name="name" class="form-control" placeholder="e.g. PCI, Production" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Tag</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Accept Risk Modal -->
<div class="modal fade" id="snoozeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="snoozeForm" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Accept Risk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Temporarily accept this risk and hide it from reports. It will reappear after the duration
                        expires.</p>
                    <div class="mb-3">
                        <label class="form-label">Duration</label>
                        <select name="days" class="form-select">
                            <option value="30">30 Days (Standard Exception)</option>
                            <option value="60">60 Days</option>
                            <option value="90">90 Days (Quarterly Review)</option>
                            <option value="365">1 Year (Permanent Exception)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Justification</label>
                        <textarea name="reason" class="form-control" rows="3"
                            placeholder="e.g. System is air-gapped; Patch causes breaking change..."
                            required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Confirm Acceptance</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Manual Resolution Modal -->
<div class="modal fade" id="resolveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="resolveForm" method="POST">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manual Resolution</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Confirm that you have manually resolved this finding. Use this if the scanner hasn't detected the
                        fix yet or for non-detectable mitigations.</p>
                    <div class="mb-3">
                        <label class="form-label">Resolution Note</label>
                        <textarea name="note" class="form-control" rows="3"
                            placeholder="e.g. Applied KB12345; Configuration change verified..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Mark as Resolved</button>
                </div>
            </div>
        </form>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function removeTag(tagId, tagName) {
        if (!confirm('Remove tag ' + tagName + '?')) return;
        const hostIdInput = document.getElementById('hostIdField');
        if (!hostIdInput) return;
        const hostId = hostIdInput.value;
        fetch('/api/hosts/' + hostId + '/tags/' + tagName, { method: 'DELETE' })
            .then(res => res.ok ? location.reload() : alert('Failed to remove tag'));
    }

    function openSnooze(findingId) {
        const form = document.getElementById('snoozeForm');
        form.action = '/api/findings/' + findingId + '/snooze';
        new bootstrap.Modal(document.getElementById('snoozeModal')).show();
    }

    function openResolve(findingId) {
        const form = document.getElementById('resolveForm');
        form.action = '/api/findings/' + findingId + '/resolve';
        new bootstrap.Modal(document.getElementById('resolveModal')).show();
    }

    // Submit handlers
    document.addEventListener("DOMContentLoaded", function () {
        const snoozeForm = document.getElementById('snoozeForm');
        if (snoozeForm) {
            snoozeForm.addEventListener('submit', function (e) {
                e.preventDefault();
                fetch(this.action, { method: 'POST', body: new FormData(this) })
                    .then(res => res.ok ? location.reload() : alert('Failed to accept risk'));
            });
        }

        const resolveForm = document.getElementById('resolveForm');
        if (resolveForm) {
            resolveForm.addEventListener('submit', function (e) {
                e.preventDefault();
                fetch(this.action, { method: 'POST', body: new FormData(this) })
                    .then(res => res.ok ? location.reload() : alert('Failed to resolve finding'));
            });
        }
    });

    function filterFindings() {
        const query = document.getElementById('findingSearch').value.toUpperCase();
        const tables = ['activeFindingsTable', 'resolvedFindingsTable', 'acceptedFindingsTable'];
        tables.forEach(tableId => {
            const table = document.getElementById(tableId);
            if (!table) return;
            const tr = table.getElementsByTagName("tr");
            for (let i = 1; i < tr.length; i++) {
                let found = false;
                for (let j = 1; j <= 5; j++) {
                    const td = tr[i].getElementsByTagName("td")[j];
                    if (td) {
                        const txtValue = td.textContent || td.innerText;
                        if (txtValue.toUpperCase().indexOf(query) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                tr[i].style.display = found ? "" : "none";
            }
        });
    }

    // Safe Initialization Logic that doesn't rely on inline Go templates
    document.addEventListener("DOMContentLoaded", function () {
        console.log("Initializing charts from DOM...");

        // Helper to normalize severity string (e.g. "CRITICAL" -> "Critical")
        function normalizeSeverity(text) {
            if (!text) return "Info";
            const upper = text.toUpperCase().trim();
            if (upper === "CRITICAL") return "Critical";
            if (upper === "HIGH") return "High";
            if (upper === "MEDIUM") return "Medium";
            if (upper === "LOW") return "Low";
            return "Info";
        }

        let stats = { Critical: 0, High: 0, Medium: 0, Low: 0, Info: 0 };

        // Parse Active Table
        const activeTable = document.getElementById('activeFindingsTable');
        if (activeTable) {
            const activeRows = activeTable.querySelectorAll('tbody tr');
            activeRows.forEach(row => {
                const sevCell = row.cells[0]; // Severity is index 0
                if (sevCell) {
                    const badge = sevCell.querySelector('.badge');
                    if (badge) {
                        const sev = normalizeSeverity(badge.innerText);
                        if (stats[sev] !== undefined) stats[sev]++;
                    }
                }
            });
        }

        // Parse Resolved Table for Fixed stats
        let fixedStats = { Critical: 0, High: 0, Medium: 0, Low: 0, Info: 0 };
        const resolvedTable = document.getElementById('resolvedFindingsTable');
        if (resolvedTable) {
            const resolvedRows = resolvedTable.querySelectorAll('tbody tr');
            resolvedRows.forEach(row => {
                const sevCell = row.cells[0];
                if (sevCell) {
                    const badge = sevCell.querySelector('.badge');
                    if (badge) {
                        const sev = normalizeSeverity(badge.innerText);
                        if (fixedStats[sev] !== undefined) fixedStats[sev]++;
                    }
                }
            });
        }

        // Render Active Chart
        const ctx = document.getElementById('vulnChart');
        if (ctx) {
            const total = Object.values(stats).reduce((a, b) => a + b, 0);
            if (typeof Chart !== 'undefined' && total > 0) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
                        datasets: [{
                            data: [stats.Critical, stats.High, stats.Medium, stats.Low, stats.Info],
                            backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#0dcaf0', '#6c757d'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'right' } },
                        cutout: '70%'
                    }
                });
            } else {
                ctx.parentElement.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-check-circle display-4 text-success opacity-50"></i><p class="mt-2">No active vulnerabilities</p></div>';
            }
        }

        // Render Fixed Chart
        const ctxFixed = document.getElementById('fixedVulnChart');
        if (ctxFixed) {
            const totalFixed = Object.values(fixedStats).reduce((a, b) => a + b, 0);
            if (typeof Chart !== 'undefined' && totalFixed > 0) {
                new Chart(ctxFixed, {
                    type: 'doughnut',
                    data: {
                        labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
                        datasets: [{
                            data: [fixedStats.Critical, fixedStats.High, fixedStats.Medium, fixedStats.Low, fixedStats.Info],
                            backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#0dcaf0', '#6c757d'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' },
                            title: { display: true, text: 'Remediated Vulnerabilities' }
                        },
                        cutout: '70%'
                    }
                });
            } else {
                ctxFixed.parentElement.innerHTML = '<div class="text-center py-5 text-muted"><p class="small">No remediation history available</p></div>';
            }
        }
    });
</script>
{{end}}