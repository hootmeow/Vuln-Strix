{{define "content"}}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card text-white bg-danger mb-3">
            <div class="card-header">Critical Vulnerabilities</div>
            <div class="card-body">
                <h5 class="card-title display-4">{{.Stats.Critical}}</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-warning mb-3">
            <div class="card-header">High Vulnerabilities</div>
            <div class="card-body">
                <h5 class="card-title display-4">{{.Stats.High}}</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-primary mb-3">
            <div class="card-header">Total Hosts</div>
            <div class="card-body">
                <h5 class="card-title display-4">{{.Stats.Hosts}}</h5>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header">
                Vulnerability Trends (Last 6 Months)
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                Top Risk Families
            </div>
            <div class="card-body">
                <canvas id="familyChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Upload moved to Settings/Admin -->

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // --- Trend Chart ---
        const rawScans = {{ .Scans | json
    }};
    const scans = rawScans ? rawScans.map(s => ({
        date: new Date(s.ScanStart).toISOString().split('T')[0],
        count: (s.CriticalCount || 0) + (s.HighCount || 0) + (s.MediumCount || 0) + (s.LowCount || 0)
    })) : [];

    scans.sort((a, b) => new Date(a.date) - new Date(b.date));
    const trendLabels = scans.map(s => s.date);
    const trendData = scans.map(s => s.count);

    const ctxTrend = document.getElementById('trendChart');
    if (ctxTrend) {
        new Chart(ctxTrend, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Total Vulnerabilities',
                    data: trendData,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // --- Family Chart ---
    const familyStats = {{ .FamilyStats | json }};
    const families = [];

    // Convert Map to Array {name, count}
    if (familyStats) {
        for (const [name, count] of Object.entries(familyStats)) {
            families.push({ name: name, count: count });
        }
    }

    // Sort by count desc and take top 5
    families.sort((a, b) => b.count - a.count);
    const topFamilies = families.slice(0, 5);

    const famLabels = topFamilies.map(f => f.name);
    const famData = topFamilies.map(f => f.count);

    const ctxFam = document.getElementById('familyChart');
    if (ctxFam) {
        new Chart(ctxFam, {
            type: 'doughnut',
            data: {
                labels: famLabels,
                datasets: [{
                    data: famData,
                    backgroundColor: [
                        '#dc3545', '#fd7e14', '#ffc107', '#0d6efd', '#6c757d'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    });
</script>
{{end}}